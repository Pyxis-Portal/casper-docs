---
title: AWS Modules
---

# AWS Modules

## Alerting Modules

The alerting services provided by AWS let us monitor the node status and also the Casper service status, by creating alarms and having a visual representation in a dashboard, being able to see the node's resources and capacity in real time.

| AWS Services Used |
| ---- |
| Cloudwatch Dashboard |
| Logs |
| Synthetic Canary |
| Alarms |

### Cloudwatch Main Module

The following is an example of the Dashboard created by the IaC

<p align="center">
<img src={"/image/operators/dashboardcw.png"} alt="Casper Dashboard" width="600"/>
</p>

#### Alarms

The following table shows the alarms created by the module and their respective configuration:

| Alarm | Description |
| ----- | ----------- |
| CPU Alarm | CPU Alarm activated when usage is above 70% |
| RAM Alarm | RAM Alarm activated when usage is above 80% |
| DISK Alarm | DISK Alarm activated when usage is above 90% |

##### Alarms Menu

<p align="center">
<img src={"/image/operators/AlarmsCreated.png"} alt="Alarms Created" width="600"/>
</p>

##### Alarm email Notification

<p align="center">
<img src={"/image/operators/AlarmOutput.png"} alt="Alarm Output Example" width="600"/>
</p>

### Synthetic Canary

The synthetic canary created by the module checks the status of the `casper-node-launcher` service by checking the endpoint  `http://NODE_IP:8888/status`

#### Running Example

This is an example of the output when the canary  detects whether the service is up or down:

<p align="center">
<img src={"/image/operators/Canary_CasperService.png"} alt="Canary Casper Service Example" width="600"/>
</p>

### Log Group

This is the log Group module for the **Synthetic Canary Service**. All logs derived from those tests will be stored in the created Log Group.

The following logs are stored:

| Name| Description |
| --- | --- |
| casper-node.log | Casper Service logs |
| casper-node.stderr.log | Casper Service error logs |

### Subscriber List

The subscriber module creates an SNS Topic with the emails provided (which are inside the root `terragrunt.hcl` file. The SNS Topic is used by the alarms to be able to send email notifications when an Alarm is activated.

### Configuration Cloudwatch Agent

This is the configuration file for the Cloudwatch Agent inside the node.

The Cloudwatch Agent will obtain the following metrics every 30 seconds:

| Metrics | Description |
| ------- | ----------- |
| casper-node logs | casper service logs |
| casper-node error logs | casper service error logs |
| disk_total | disk total capacity |
| disk_used | disk usage in GB |
| disk_percent | disk usage in percentage |
| mem_used | RAM usage in GB |
| mem_used_percent | RAM usage in percentage |

## Bucket Modules

### S3 Canary

This module creates an S3 Bucket to store all the logs generated by the *Synthetic Canary Service*. It is called by the `alerting/iam_canary_s3` module.

### S3 Config

This module creates an S3 Bucket where all the additional files for configuration (`zip`,`.json`,`.sh`) will be stored.

## Compute Modules

### ASG Module

#### Description

The Auto-Scaling Group (ASG), is used for providing an automatic deployment of the node if for some reason the node shuts down.

The ASG provided contains a launch template with all the configurations needed to set up the `casper-launcher` automatically and as soon as the EC2 instance starts running.

It also is available in 3 Public Subnets for better support and availability in the Casper Network.

## EC2 Instance

### System Requirements

| Requirements | Description |
| --- | --- |
| O.S. | Ubuntu 20.04 LTS |
| RAM | 32 GB |
| Disk Space| 2 TB |
| CPU Cores | 8 |
| AMI | ubuntu/images/hvm-ssd/ubuntu-focal-20.04-amd64-server-20211129 |
| AMI_Type| t3.2xlarge |

### Ports Available

The following ports are open to be able to run successfully the Casper service:

| PORT  | Description                                                                                                 |
| ----- | ----------------------------------------------------------------------------------------------------------- |
| 22    | SSH                                                                            |
| 3000  | Grafana dashboard                                                                                           |
| 7777  | RPC endpoint for interaction with JSON-RPC API                                                              |
| 8888  | REST endpoint for status and metrics (having this accessible allows your node to be part of network status) |
| 9999  | SSE endpoint for event stream                                                                               |
| 35000 | required to be externally visible                                                                           |

### Config Files

#### casper-node-install-configure.sh.tftpl

A template that converts to a bash file when terragrunt is executed. It contains all the installation and configuration commands needed by the casper-service and monitoring services (AWS Cloudwatch Agent and Grafana (Docker)). It calls the other bash files to finish the configuration for backup and cloudwatch.

#### Other Configuration files

Please go to the config module for a detailed explanation of the other configuration files that are referenced inside the code of the `casper-node-install-configure.sh.tftpl` file. The reason it needs to be separated is that there is a character limit for script templates in AWS.

### Setup Process

This is the workflow of the EC2 Instance Creation

<p align="center">
<img src={"/image/operators/ASGWorkflow.png"} alt="EC2 Workflow" width="600"/>
</p>

### Config Bucket Module

This terragrunt creates a S3 Bucket and uploads all the configuration files needed to set up all the services (Casper, monitoring, backup and restore) inside the node.

### Configuration Files

Below is a detailed description of each configuration file.

| File | Description |
| ---- | ----------- |
| files/genCustomMetrics.sh | Bash file that contains the configuration to get casper-node metric information from the Grafana dashboard and places them in the dashboard.sh file so the metrics can be seen in the Cloudwatch Dashboard.|
| files/genSnapshot.sh | Bash file that contains the configuration to create a snapshot volume in EBS, with a cronjob that backs up weekly. |
| files/genVolumenID.sh | Bash file Obtain the ID of the volume to be created and validate if there is a snapshot of a previous volume, if there is, create the volume based on it. Otherwise, create a completely new volume. |
| files/deleteSm.sh | Bash file that deletes the secret keys of casper from the AWS secret manager. *Note: It is not used currently.* |
| files/dashboard.json | Template of the dashboard to generate and watch all the metrics needed for ideal monitoring setup.|

## Key Pairs Module

The Key Pairs module generates a `.pem` file that will be used to create and be able connect to the `Open VPN` instance and the `casper-node`instance.

## Security Group Rules Module

The Security Group Rules module will detect if the node `Operator` wants the `Open VPN` instance or not, and will create a customized *SSH* `Ingress-Rule` for the `casper-node` instance.

| Open VPN Status | Ingress Rule |
| -- | -- |
| Created | SSH will only be available when connected to the VPN Server |
| Discarded | SSH will be available to the IPs the Operator listed |

## OPEN VPN SERVER Module

The OpenVPN Service is used to provide a private and secure connection to the node for the administrators.

It is a simple VPN that is only available for 5 maintainers (or administrators).

To configure the VPN Server please read the [guide](./5-open-vpn.md).

### Ports

The following ports are open to be able to run successfully the Casper service:

| PORT | Description                      |
| ---- | -------------------------------- |
| 22   | SSH (For connection to the node) |
| 80   | Dashboard for configuration      |

## Data Modules

### Dashboard Template Module

The Template Module creates and configures the *Cloudwatch Dashboard*. The module is called the `alerting/cloudwatch` Module.

### Cloudwatch Canary Code Template Module

The Template_CW_CF uses the `cw_agent_config.json` template file to add and configure the `cw_namespace` and `aws_region` variables provided in the root `terragrunt.hcl` file.

### Zip Creation Module

This template_zip module creates the `ZIP` file necessary for the *Canary Synthetic Service* to be able to monitor the `casper-node-launcher` service in port `8888`.

## Elastic IP Module

The EIP module creates the Elastic IP (Public IP) for the casper node.

## VPC Module

The VPC Module creates the Networking Layer where the casper non-validator node will be operating.
The module configures the following services:

| Services |
| -------- |
| Public Subnets (3 Availability zones) |
| Route tables |
| VPC |
