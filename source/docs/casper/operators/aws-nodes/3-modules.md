---
title: AWS Modules
---

# AWS Modules

This section describes AWS modules helpful for running and monitoring the node.

## Monitoring Modules

This section describes all the modules related to monitoring the node. AWS provides various services to help operators monitor the node and Casper service status by creating alarms and having a visual representation in a dashboard, thus presenting the node's resources and capacity in real time.

| AWS Services Used | Description |
| ---- | ---- |
| CloudWatch Dashboard | Customized views of metrics and alarms for AWS resources. |
| CloudWatch Alarms | Sends a message or performs an action when the alarm changes state. |
| CloudWatch Synthetics | Canaries as scripts to monitor endpoints and APIs. |
| CloudWatch Agent | Collects metrics, logs, and traces from Amazon EC2 instances. |
| CloudWatch Logs | Centralized logs from all systems, applications, and AWS services. |
<!-- TODO the logs are not described below. -->

### CloudWatch Dashboard

The IaC creates a dashboard to monitor all related resources. The dashboard includes metrics for connectivity status, blockchain information such as block height, block time, and era count, and node metrics such as CPU, memory, and disk usage metrics.

<p align="center">
<img src={"/image/operators/dashboardcw.png"} alt="CloudWatch dashboard for Casper metrics"/>
</p>

### CloudWatch Alarms

The following table shows the alarms created by the module and their respective configuration:

| Alarm | Description |
| ----- | ----------- |
| CPU Alarm | CPU Alarm activates when usage is above 70%. |
| RAM Alarm | RAM Alarm activates when usage is above 80%. |
| DISK Alarm | DISK Alarm activates when usage is above 90%. |

**Sample alarms:**

<p align="center">
<img src={"/image/operators/AlarmsCreated.png"} alt="Alarms created"/>
</p>

**Sample email notification:**

<p align="center">
<img src={"/image/operators/AlarmOutput.png"} alt="Alarm email notification"/>
</p>

#### Subscriber List

The subscriber module creates an SNS Topic with the emails provided inside the root `terragrunt.hcl` file. The alarms use the SNS Topic to send email notifications when an Alarm is activated.

### CloudWatch Synthetics

The synthetic canary created by the CloudWatch Synthetics module checks the status of the `casper-node-launcher` service by checking this endpoint: `http://NODE_IP:8888/status`.

This is an example of the output when the canary  detects whether the service is up or down:

<p align="center">
<img src={"/image/operators/Canary-CasperService.png"} alt="Canary Casper service example"/>
</p>

#### Canary Log Group

A Log Group module for the **synthetic canary service** stores all logs derived from the canary tests as follows:

| Name| Description |
| --- | --- |
| casper-node.log | Casper Service logs. |
| casper-node.stderr.log | Casper Service error logs. |

### CloudWatch Agent

A CloudWatch Agent obtains the following metrics every 30 seconds:

| Metrics | Description |
| ------- | ----------- |
| casper-node logs | casper service logs |
| casper-node error logs | casper service error logs |
| disk_total | disk total capacity |
| disk_used | disk usage in GB |
| disk_percent | disk usage in percentage |
| mem_used | RAM usage in GB |
| mem_used_percent | RAM usage in percentage |

<!-- TODO figure out how to introduce non-monitoring modules -->

## S3 Bucket Modules

The following modules create S3 bucket resources on AWS.

### S3 Canary

An S3 canary module creates an S3 bucket to store all the logs generated by the [synthetic canary service](#CloudWatch-Synthetics). The `alerting/iam_canary_s3` module calls this module.

### S3 Config

The S3 config module creates an S3 bucket for storing additional configuration files such as `zip`,`.json`, or `.sh`.

## Auto-Scaling Module

An Auto-Scaling Group (ASG) is used for an automatic deployment if the node shuts down. The ASG contains a launch template with all the configurations needed to automatically set up the `casper-launcher` when the EC2 instance starts running. Also, the ASG is available in 3 public subnets for better support.

<!-- TODO move this to a new file? -->

## EC2 Instance Requirements

The following requirements describe the optimal EC2 Instance for running a Casper node.

| Requirements | Description |
| --- | --- |
| O.S. | Ubuntu 20.04 LTS |
| RAM | 32 GB |
| Disk Space| 2 TB |
| CPU Cores | 8 |
| AMI | ubuntu/images/hvm-ssd/ubuntu-focal-20.04-amd64-server-20211129 |
| AMI_Type| t3.2xlarge |

### Available Ports

The following ports are open to run the Casper service successfully:

| PORT  | Description                                                                                                 |
| ----- | ----------------------------------------------------------------------------------------------------------- |
| 22    | SSH connectivity                                                                                            |
| 3000  | Grafana dashboard                                                                                           |
| 7777  | RPC endpoint for interaction with the node's JSON-RPC API                                                   |
| 8888  | REST endpoint for status and metrics. Having this accessible allows the node to be part of the network status|
| 9999  | SSE endpoint for the event stream                                                                           |
| 35000 | Required to be part of the network                                                                          |

### Configuration Files

The `casper-node-install-configure.sh.tftpl` is a template that converts to a bash file when Terragrunt runs. It contains all the installation and configuration commands the `casper-service` and monitoring services (e.g., CloudWatch Agent and Grafana) need. This bash file calls other bash files to finish the configuration for backup and CloudWatch.

To see more configuration files, go to the config module. You will see a detailed explanation of the other configuration files referenced inside the code of the `casper-node-install-configure.sh.tftpl` file. This file needs to be separated because there is a character limit for script templates in AWS.

### EC2 Instance Creation

This is the workflow of creating the EC2 instance for a Casper node in AWS:

<p align="center">
<img src={"/image/operators/ASGWorkflow.png"} alt="EC2 Workflow"/>
</p>

## Configuration Bucket Module

Terragrunt creates an S3 bucket and uploads all the configuration files needed to set up all the required services inside the node, including the Casper service and other services used for monitoring, backing up, and restoring the node. Below is a detailed description of each configuration file.

| File | Description |
| ---- | ----------- |
| files/genCustomMetrics.sh | Bash file containing the configuration to get casper-node metrics from the Grafana dashboard and place them in the dashboard.sh file for the CloudWatch Dashboard.|
| files/genSnapshot.sh | Bash file containing the configuration to create a snapshot volume in EBS, with a cronjob performing weekly backups. |
| files/genVolumenID.sh | Bash file to create a volume based on the snapshot of a previous volume, given its ID; if the snapshot does not exist, the script will create a completely new volume. |
| files/dashboard.json | Dashboard template to generate and watch node metrics. |
| files/deleteSm.sh | NOT IN USE. Deletes the Casper secret keys from the AWS Secrets Manager. |

## Key Pairs Module

The Key Pairs module generates a `.pem` file for creating and connecting to the `OpenVPN` and `casper-node` instances.

## Security Group Rules Module

The Security Group Rules module detects whether the node operator wants the `OpenVPN` instance and creates a customized SSH `Ingress-Rule` for the `casper-node` instance.

| OpenVPN Status | Ingress Rule |
| -- | -- |
| Created | SSH will only be available when connected to the VPN Server. |
| Discarded | SSH will be available to the IPs the operator listed. |

## OpenVPN Server Module

The OpenVPN Service provides the administrators a private and secure connection to the node. This simple VPN is available for five administrators. To configure the VPN server, read the [OpenVPN guide](./5-open-vpn.md).

### Ports

The following ports are open to run the Casper service successfully:

| Port | Description                      |
| ---- | -------------------------------- |
| 22   | For SSH connections to the node  |
| 80   | For retrieving dashboard metrics |

## Data Modules

### Dashboard Template Module

The template module `alerting/cloudwatch` creates and configures the CloudWatch dashboard.

### CloudWatch Canary Code Template Module

The CloudWatch canary code template module, `Template_CW_CF`, uses the `cw_agent_config.json` template file to add and configure the `cw_namespace` and `aws_region` variables provided in the root file `terragrunt.hcl`.

### ZIP Creation Module

The ZIP template module creates the ZIP file necessary for the [synthetic canary service](#CloudWatch-Synthetics) to monitor the `casper-node-launcher` on port `8888`.

## Elastic IP Module

The Elastic IP (EIP) module creates the public IP for the Casper node.

## VPC Module

The VPC module creates the networking layer where the Casper read-only node will run. This module configures the following services:

| Services | Description |
| -------- | ----------- |
| Amazon VPC     | A virtual private cloud within the AWS Cloud. |
| Public subnets | Range of IP addresses in 3 availability zones. |
| Route tables   | Tables controlling where network traffic is directed. |

